<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Single Page CRUD App (jQuery + REST API)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Alegreya', serif;
    }
    .container {
      margin-top: 50px;
    }
    .card {
      background: #1b1b1b;
      border: none;
    }
    .btn-warning {
      color: #111;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center mb-4 text-warning">Single Page CRUD App (jQuery + REST API)</h2>

  <!-- Form -->
  <div class="card p-4 mb-4">
    <form id="postForm">
      <input type="hidden" id="postId">
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input type="text" id="title" class="form-control" placeholder="Enter post title" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Body</label>
        <textarea id="body" class="form-control" rows="3" placeholder="Enter post content" required></textarea>
      </div>
      <button type="submit" class="btn btn-warning">Save</button>
      <button type="button" id="cancelEdit" class="btn btn-secondary d-none">Cancel</button>
    </form>
  </div>

  <!-- Loading Spinner -->
  <div id="loading" class="text-center my-4" style="display:none;">
    <div class="spinner-border text-warning" role="status"></div>
    <p>Loading...</p>
  </div>

  <!-- Table -->
  <div class="card p-3">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Body</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="postTableBody"></tbody>
    </table>
  </div>
</div>

<script>
  const API_URL = "https://jsonplaceholder.typicode.com/posts";

  // Load posts on page load
  $(document).ready(function () {
    fetchPosts();
  });

  // Fetch (Read)
  function fetchPosts() {
    $("#loading").show();
    $.get(API_URL, function (data) {
      $("#loading").hide();
      $("#postTableBody").empty();
      data.slice(0, 10).forEach(post => {
        appendPostRow(post);
      });
    }).fail(function () {
      $("#loading").hide();
      alert("‚ùå Failed to load data.");
    });
  }

  // Append a row to table using data-* attributes (no inline onclick)
  function appendPostRow(post) {
    // safely encode title/body into data attributes
    const encodedTitle = encodeURIComponent(post.title ?? "");
    const encodedBody = encodeURIComponent(post.body ?? "");
    const row = `
      <tr id="row-${post.id}">
        <td>${post.id}</td>
        <td class="col-title">${escapeHtml(post.title)}</td>
        <td class="col-body">${escapeHtml(post.body)}</td>
        <td>
          <button class="btn btn-success btn-sm me-1 edit-btn"
                  data-id="${post.id}"
                  data-title="${encodedTitle}"
                  data-body="${encodedBody}">Edit</button>
          <button class="btn btn-danger btn-sm delete-btn" data-id="${post.id}">Delete</button>
        </td>
      </tr>
    `;
    $("#postTableBody").append(row);
  }

  // small helper to avoid raw HTML injection in table cells
  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // Create or Update (POST / PUT)
  $("#postForm").submit(function (e) {
    e.preventDefault();

    const id = $("#postId").val();
    const postData = {
      title: $("#title").val(),
      body: $("#body").val(),
      userId: 1
    };

    if (id) {
      // Update existing row visually and call API
      $.ajax({
        url: `${API_URL}/${id}`,
        method: "PUT",
        data: JSON.stringify(postData),
        contentType: "application/json; charset=UTF-8",
        success: function (updatedPost) {
          alert("‚úÖ Post updated successfully!");

          // Update data-* attributes and visible cells for that row
          const $row = $(`#row-${id}`);
          $row.find(".col-title").text(postData.title);
          $row.find(".col-body").text(postData.body);

          // update data attributes on Edit button
          $row.find(".edit-btn")
            .data("title", encodeURIComponent(postData.title))
            .attr("data-title", encodeURIComponent(postData.title));
          $row.find(".edit-btn")
            .data("body", encodeURIComponent(postData.body))
            .attr("data-body", encodeURIComponent(postData.body));

          resetForm();
        },
        error: function () {
          alert("‚ùå Error updating post.");
        }
      });
    } else {
      // Create
      $.ajax({
        url: API_URL,
        method: "POST",
        data: JSON.stringify(postData),
        contentType: "application/json; charset=UTF-8",
        success: function (newPost) {
          alert("‚úÖ Post created successfully!");

          // JSONPlaceholder returns an id (usually 101) ‚Äî ensure newPost has id
          if (!newPost.id) {
            // if API didn't return id, create a temporary unique id
            newPost.id = Date.now();
          }
          // set title/body on returned object so append works
          newPost.title = postData.title;
          newPost.body = postData.body;

          appendPostRow(newPost);
          resetForm();
        },
        error: function () {
          alert("‚ùå Error creating post.");
        }
      });
    }
  });

  // Event delegation for Edit buttons
  $(document).on("click", ".edit-btn", function () {
    const $btn = $(this);
    const id = $btn.data("id");
    const title = decodeURIComponent($btn.attr("data-title") || $btn.data("title") || "");
    const body = decodeURIComponent($btn.attr("data-body") || $btn.data("body") || "");

    $("#postId").val(id);
    $("#title").val(title);
    $("#body").val(body);
    $("#cancelEdit").removeClass("d-none");
  });

  // Event delegation for Delete buttons
  $(document).on("click", ".delete-btn", function () {
    const id = $(this).data("id");
    deletePost(id);
  });

  // Cancel edit
  $("#cancelEdit").click(function () {
    resetForm();
  });

  function resetForm() {
    $("#postForm")[0].reset();
    $("#postId").val("");
    $("#cancelEdit").addClass("d-none");
  }

  // Delete (with delegation already wired)
  function deletePost(id) {
    if (!confirm("Are you sure you want to delete this post?")) return;

    $.ajax({
      url: `${API_URL}/${id}`,
      method: "DELETE",
      success: function () {
        alert("üóëÔ∏è Post deleted successfully!");
        $(`#row-${id}`).remove();
      },
      error: function () {
        alert("‚ùå Error deleting post.");
      }
    });
  }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
